name: Sync and Patch Unmanic

on:
  schedule:
    - cron: "0 9 * * 5"  # Viernes a las 09:00 UTC
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout FOSSmanic repo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_REPO_DISPATCH }}
        ref: main

      - name: Set variables
        run: |
          UPSTREAM_REPO="https://github.com/Unmanic/unmanic.git"
          TEMP_BRANCH="temp-sync-$(date +%Y%m%d-%H%M%S)"
          echo "UPSTREAM_REPO=$UPSTREAM_REPO" >> $GITHUB_ENV
          echo "TEMP_BRANCH=$TEMP_BRANCH" >> $GITHUB_ENV

      - name: Clone Unmanic upstream
        run: |
          git clone --depth=1 $UPSTREAM_REPO upstream
          cd upstream
          git checkout -b $TEMP_BRANCH

      - name: Copy custom FOSSmanic files
        run: |
          cp foss/foss.py upstream/unmanic/libs/session.py
          cp foss/icon.png upstream/icon.png
          cp foss/logo.png upstream/logo.png
          cp foss/logo-white_font.png upstream/logo-white_font.png
          cp foss/README.md upstream/README.md

      - name: Commit and push patched code
        run: |
          cd upstream
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore: sync and patch Unmanic from FOSSmanic"
          git push https://x-access-token:${{ secrets.PAT_REPO_DISPATCH }}@github.com/JMVS/FOSSmanic.git HEAD:main

      - name: Cleanup
        if: always()
        run: |
          cd upstream
          git push origin --delete $TEMP_BRANCH || true
